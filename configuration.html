<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="css/configuration-styles.css">

    <script src="sdk/scripts/VSS.SDK.min.js"></script>
    <script type="text/javascript">

        VSS.init({
            explicitNotifyLoaded: true,
            usePlatformStyles: true
        });

        VSS.require("TFS/Dashboards/WidgetHelpers", function (WidgetHelpers) {
            VSS.register("SpringActuatorWidget.Configuration", function () {
                var $queryUrl = $("#urlInput");
                var $queryName = $("#nameInput");
                var $infoCheckbox = $("#infoCheckbox");
                var $metricsCheckbox = $("#metricsCheckbox");
                var $heapDumpCheckbox = $("#heapdumpCheckbox");
                var $threadDumpCheckbox = $("#threaddumpCheckbox");

                const nameInput = document.getElementById('nameInput');
                const urlInput = document.getElementById('urlInput');
                const textError = document.getElementById('textError');
                const urlError = document.getElementById('urlError');
                const urlStatus = document.getElementById('urlStatus');

                function validateURL(string) {
                    try {
                        new URL(string);
                        return true;
                    } catch (_) {
                        return false;
                    }
                }

                function validateUrlInput() {
                    const urlValue = urlInput.value.trim();

                    if (!urlValue) {
                        urlInput.classList.remove('error', 'success');
                        urlError.classList.remove('show');
                        updateUrlStatus(false, false);
                    } else if (!validateURL(urlValue)) {
                        urlInput.classList.add('error');
                        urlInput.classList.remove('success');
                        urlError.textContent = 'Please enter a valid URL';
                        urlError.classList.add('show');
                        updateUrlStatus(false, true);
                    } else {
                        urlInput.classList.remove('error');
                        urlInput.classList.add('success');
                        urlError.classList.remove('show');
                        updateUrlStatus(true, true);
                    }
                }

                function updateUrlStatus(isValid, hasValue) {
                    if (!hasValue) {
                        urlStatus.innerHTML = '';
                        return;
                    }

                    if (isValid) {
                        urlStatus.innerHTML = '<span class="url-icon valid"></span>';
                    } else {
                        urlStatus.innerHTML = '<span class="url-icon invalid">X</span>';
                    }
                }

                function updateOutput(widgetConfigurationContext) {
                    let url = $queryUrl.val().trim();
                    if (url.endsWith('/')) {
                        url = url.slice(0, -1);
                    }
                    var customSettings = {
                        data: JSON.stringify({
                            queryPath: url,
                            urlName: $queryName.val(),
                            info: $infoCheckbox.is(":checked"),
                            metrics: $metricsCheckbox.is(":checked"),
                            heapDump: $heapDumpCheckbox.is(":checked"),
                            threadDump: $threadDumpCheckbox.is(":checked")
                        })
                    };

                    var eventName = WidgetHelpers.WidgetEvent.ConfigurationChange;
                    var eventArgs = WidgetHelpers.WidgetEvent.Args(customSettings);
                    widgetConfigurationContext.notify(eventName, eventArgs);
                }

                return {
                    load: function (widgetSettings, widgetConfigurationContext) {
                        var settings = JSON.parse(widgetSettings.customSettings.data);
                        if (settings && settings.queryPath) {
                            $queryUrl.val(settings.queryPath);
                            $queryName.val(settings.urlName);
                            $infoCheckbox.prop("checked", settings.info || false);
                            $metricsCheckbox.prop("checked", settings.metrics || false);
                            $heapDumpCheckbox.prop("checked", settings.heapDump || false);
                            $threadDumpCheckbox.prop("checked", settings.threadDump || false);
                        }

                        $queryUrl.on("change", function () {
                            validateUrlInput();
                            updateOutput(widgetConfigurationContext);
                        });

                        $queryName.on("change", function () {
                            validateUrlInput();
                            updateOutput(widgetConfigurationContext);
                        });

                        $infoCheckbox.on("change", function () {
                            validateUrlInput();
                            updateOutput(widgetConfigurationContext);
                        });
                        $metricsCheckbox.on("change", function () {
                            validateUrlInput();
                            updateOutput(widgetConfigurationContext);
                        });
                        $heapDumpCheckbox.on("change", function () {
                            validateUrlInput();
                            updateOutput(widgetConfigurationContext);
                        });
                        $threadDumpCheckbox.on("change", function () {
                            validateUrlInput();
                            updateOutput(widgetConfigurationContext);
                        });

                        return WidgetHelpers.WidgetStatusHelper.Success();
                    },
                    onSave: function () {
                        let url = $queryUrl.val().trim();
                        if (url.endsWith('/')) {
                            url = url.slice(0, -1);
                        }
                        var customSettings = {
                            data: JSON.stringify({
                                queryPath: url,
                                urlName: $queryName.val(),
                                info: $infoCheckbox.is(":checked"),
                                metrics: $metricsCheckbox.is(":checked"),
                                heapDump: $heapDumpCheckbox.is(":checked"),
                                threadDump: $threadDumpCheckbox.is(":checked")
                            })
                        };
                        return WidgetHelpers.WidgetConfigurationSave.Valid(customSettings);
                    }
                }
            });
            VSS.notifyLoadSucceeded();
        });
    </script>
</head>

<body>
    <div class="input-container">
        <div class="form-group">
            <label for="nameInput" class="form-label">
                Application Name
            </label>
            <input type="text" id="nameInput" class="form-input" placeholder="Enter any text..." autocomplete="off">
            <div class="error-message" id="textError">This field is required</div>
        </div>

        <div class="form-group">
            <label for="urlInput" class="form-label">
                URL
                <span class="url-status" id="urlStatus"></span>
            </label>
            <input type="url" id="urlInput" class="form-input" placeholder="https://example.com/application/actuator"
                autocomplete="off">
            <div class="error-message" id="urlError">Please enter a valid URL</div>
        </div>
        <div class="checkbox-group">
            <div class="checkbox-item">
                <input type="checkbox" id="infoCheckbox" class="checkbox-input">
                <label for="infoCheckbox" class="checkbox-label">Info</label>
            </div>
            <div class="checkbox-item">
                <input type="checkbox" id="metricsCheckbox" class="checkbox-input">
                <label for="metricsCheckbox" class="checkbox-label">Metrics</label>
            </div>
            <div class="checkbox-item">
                <input type="checkbox" id="heapdumpCheckbox" class="checkbox-input">
                <label for="heapdumpCheckbox" class="checkbox-label">Heap dump</label>
            </div>
            <div class="checkbox-item">
                <input type="checkbox" id="threaddumpCheckbox" class="checkbox-input">
                <label for="threaddumpCheckbox" class="checkbox-label">Thread dump</label>
            </div>
        </div>
    </div>



    <!-- <div class="container">
        <fieldset>
            <label class="label">Name: </label>
            <input type="text" id="urlName" style="margin-top:10px" placeholder="Enter Name" />
        </fieldset>
        <fieldset>
            <label class="label">URL: </label>
            <input type="text" id="urlPath" style="margin-top:10px" placeholder="Enter URL" />
        </fieldset>
    </div> -->
</body>

</html>