<!DOCTYPE html>
<html>
<meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">

<head>
    <link rel="stylesheet" href="css/widget-styles.css">
    <script src="sdk/scripts/VSS.SDK.min.js"></script>
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <script type="text/javascript">
        VSS.init({
            explicitNotifyLoaded: true,
            usePlatformStyles: true
        });

        var getVersionInfo = async function (infoQueryPath) {
            const response = fetch(infoQueryPath, {
                cache: 'no-store',
                method: 'GET',
                mode: 'cors'
            }).then(response => {
                response.json().then(data => {
                    var $versionContainer = $('#appVersion');
                    if (data) {
                        $versionContainer.text(data.build.version || "Version unavailable");
                    } else {
                        $versionContainer.text("Version unavailable");
                    }

                    if ($versionContainer.text === "Version unavailable") {
                        $versionContainer.attr("class", "info-error");
                    } else {
                        $versionContainer.attr("class", "app-version");
                    }
                });
                return response;
            }).catch(error => {
                var $versionContainer = $('#appVersion');
                $versionContainer.text("Version unavailable");
                $versionContainer.attr("class", "info-error");
            });
        }

        function callApi(url) {
            fetch(url, {
                cache: 'no-store',
                method: 'GET',
                mode: 'cors'
            })
                .then(response => {
                    // Parse the JSON response
                    response.json().then(data => {

                        var $statusContainer = $('#statusText');
                        var $statusIndicator = $('#statusIndicator');
                        // Log the fetched data
                        if (data && data.status !== undefined && data.status === "UP") {
                            $statusContainer.text("Healthy - All services operational");
                            $statusIndicator.attr("class", "status-indicator status-success");
                        } else {
                            $statusContainer.text("Error - Service unavailable");
                            $statusIndicator.attr("class", "status-indicator status-error");
                        }
                    });
                })
                .catch(error => {
                    var $statusContainer = $('#statusText');
                    var $statusIndicator = $('#statusIndicator');
                    $statusContainer.text("Error - Service unavailable");
                    $statusIndicator.attr("class", "status-indicator status-error");
                });
        }

        function updateLinks(url) {
            $('#infoLink').attr("href", url + "/info");
            $('#metricsLink').attr("href", url + "/metrics");
            $('#heapDumpLink').attr("href", url + "/heapdump");
            $('#threadDumpLink').attr("href", url + "/threaddump");
        }

        function initiliseStates(queryPath) {
            var statusIndicator = document.getElementById('statusIndicator');
            statusIndicator.setAttribute("class", "status-indicator status-loading");

            var statusContainer = document.getElementById('statusText');
            statusContainer.textContent = "Checking - Validating services...";

            var versionContainer = document.getElementById('appVersion');
            versionContainer.textContent = "Loading Version Info";
            versionContainer.setAttribute("class", "warning");
        }

        VSS.require(["TFS/Dashboards/WidgetHelpers", "TFS/WorkItemTracking/RestClient",], function (WidgetHelpers, TFS_Wit_WebApi) {
            WidgetHelpers.IncludeWidgetStyles();
            VSS.register("SpringActuatorWidget", function () {
                var getQueryInfo = function (widgetSettings) {
                    var projectId = VSS.getWebContext().project.id;

                    // Extract query path from widgetSettings.customSettings and ask user to configure one if none is found
                    var settings = JSON.parse(widgetSettings.customSettings.data);

                    if (!settings || !settings.queryPath) {
                        $titleContainer.text(settings.urlName || "No Name Provided");
                        $statusIndicator.attr("class", "status-indicator status-error");

                        return WidgetHelpers.WidgetStatusHelper.Success();
                    }

                    var titleContainer = document.getElementById('appName');
                    titleContainer.textContent = settings.urlName || "No Name Provided";

                    var reloadContainer = document.getElementById('reloadContainer');
                    reloadContainer.addEventListener('click', function () {
                        reload(settings.queryPath);
                    });

                    try {
                        initiliseStates();

                        const firstVisibleLink = document.querySelector('div[class*=action-link][id*="-container"]');

                        if (firstVisibleLink) {
                            firstVisibleLink.classList.add('primary-link');
                        }

                        updateLinks(settings.queryPath);

                        if (!settings.info) {
                            $('#infoLink-container').hide();
                        }
                        else {
                            $('#infoLink-container').show();
                        }

                        if (!settings.metrics) {
                            $('#metricsLink-container').hide();
                        } else {
                            $('#metricsLink-container').show();
                        }

                        if (!settings.heapDump) {
                            $('#heapDumpLink-container').hide();
                        } else {
                            $('#heapDumpLink-container').show();
                        }

                        if (!settings.threadDump) {
                            $('#threadDumpLink-container').hide();
                        } else {
                            $('#threadDumpLink-container').show();
                        }

                        callApi(settings.queryPath + "/health");

                        getVersionInfo(settings.queryPath + "/info");

                    } catch (error) {
                        // Handle any errors that occur during the fetch or parsing
                        // console.error('Error fetching data:', error);
                        $('#statusText').text("Error - Service unavailable");
                        $('#statusIndicator').attr("class", "status-indicator status-error");
                    }

                    return WidgetHelpers.WidgetStatusHelper.Success();
                }

                return {
                    load: function (widgetSettings) {
                        return getQueryInfo(widgetSettings);
                    },
                    reload: function (widgetSettings) {
                        return getQueryInfo(widgetSettings);
                    }
                }
            });

            VSS.notifyLoadSucceeded();
        });

        function reload(queryPath) {
            initiliseStates(queryPath);
            callApi(queryPath + "/health");
            getVersionInfo(queryPath + "/info");
        }
    </script>
</head>

<body>
    <div class="extension-container">
        <div class="app-header">
            <div class="app-icon">APP</div>
            <div class="app-name">
                <div id="appName">Application</div>
                <div class="app-version">
                    <div id="appVersion" class="warning">
                        Loading Version Info
                    </div>
                    <div class="reload-img-container" id="reloadContainer">
                        <img src="img/reload-icon-20.png" alt="Loading..." class="loading-spinner" />
                    </div>
                </div>
            </div>
        </div>

        <div class="status-section">
            <div class="status-label">API Status</div>
            <div class="status-indicator status-loading" id="statusIndicator">
                <div class="status-dot"></div>
                <span id="statusText">Checking - Validating services...</span>
            </div>
        </div>

        <div class="actions-section">
            <div class="action-link" id="infoLink-container">
                <a href="#" class="" id="infoLink" target="_blank">
                    Info
                </a>
            </div>
            <div class="action-link" id="metricsLink-container">
                <a href="#" class="" id="metricsLink" target="_blank">
                    Metrics
                </a>
            </div>
            <div class="action-link" id="heapDumpLink-container">
                <a href="#" class="" id="heapDumpLink" target="_blank">
                    Heap Dump
                </a>
            </div>
            <div class="action-link" id="threadDumpLink-container">
                <a href="#" class="" id="threadDumpLink" target="_blank">
                    Thread Dump
                </a>
            </div>
        </div>
    </div>
</body>

</html>