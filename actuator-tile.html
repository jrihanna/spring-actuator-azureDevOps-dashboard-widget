<!DOCTYPE html>
<html>
<meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">

<head>
    <link rel="stylesheet" href="css/widget-styles.css">
    <script src="sdk/scripts/VSS.SDK.min.js"></script>
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <script type="text/javascript">
        VSS.init({
            explicitNotifyLoaded: true,
            usePlatformStyles: true
        });

        var getVersionInfo = async function (infoQueryPath) {
            const response = fetch(infoQueryPath, {
                cache: 'no-store',
                method: 'GET',
                mode: 'cors'
            }).then(response => {
                response.json().then(data => {
                    var $versionContainer = $('#appVersion');
                    if (data) {
                        $versionContainer.text(data.build.version || "Version Not Available");
                    } else {
                        $versionContainer.text("Version Not Available");
                    }

                    if ($versionContainer.text === "Version Not Available") {
                        $versionContainer.attr("class", "app-version-error");
                    } else {
                        $versionContainer.attr("class", "app-version");
                    }
                });
                return response;
            }).catch(error => {
                var $versionContainer = $('#appVersion');
                $versionContainer.text("Version Not Available");
                $versionContainer.attr("class", "app-version-error");
            });
        }

        function callApi(url) {
            fetch(url, {
                cache: 'no-store',
                method: 'GET',
                mode: 'cors'
            })
                .then(response => {
                    // Parse the JSON response
                    response.json().then(data => {

                        var $statusContainer = $('#statusText');
                        var $statusIndicator = $('#statusIndicator');
                        // Log the fetched data
                        if (data && data.status !== undefined && data.status === "UP") {
                            $statusContainer.text("Healthy - All services operational");
                            $statusIndicator.attr("class", "status-indicator status-success");
                        } else {
                            $statusContainer.text("Error - Service unavailable");
                            $statusIndicator.attr("class", "status-indicator status-error");
                        }
                    });
                })
                .catch(error => {
                    var $statusContainer = $('#statusText');
                    var $statusIndicator = $('#statusIndicator');
                    $statusContainer.text("Error - Service unavailable");
                    $statusIndicator.attr("class", "status-indicator status-error");
                });
        }

        VSS.require(["TFS/Dashboards/WidgetHelpers", "TFS/WorkItemTracking/RestClient",], function (WidgetHelpers, TFS_Wit_WebApi) {
            WidgetHelpers.IncludeWidgetStyles();
            VSS.register("SpringActuatorWidget", function () {
                var projectId = VSS.getWebContext().project.id;

                var getQueryInfo = async function (widgetSettings) {

                    // Extract query path from widgetSettings.customSettings and ask user to configure one if none is found
                    var settings = JSON.parse(widgetSettings.customSettings.data);
                    var $titleContainer = $('#appName');
                    $titleContainer.text(settings.urlName || "No Name Provided");

                    var $statusContainer = $('#statusText');

                    if (!settings || !settings.queryPath) {
                        $titleContainer.text(settings.urlName || "No Name Provided");
                        $statusIndicator.attr("class", "status-indicator status-error");

                        return WidgetHelpers.WidgetStatusHelper.Success();
                    }

                    try {
                        var $statusIndicator = $('#statusIndicator');
                        $statusIndicator.attr("class", "status-indicator status-loading");
                        $statusContainer.text("Checking - Validating services...");
                        const firstVisibleLink = document.querySelector('div[class*=action-link][id*="-container"]');
                        if (firstVisibleLink) {
                            firstVisibleLink.classList.add('primary-link');
                        }

                        if (settings.info) {
                            $('#infoLink').attr("href", settings.queryPath + "/info");
                        } else {
                            $('#infoLink-container').hide();
                        }

                        if (settings.metrics) {
                            $('#metricsLink').attr("href", settings.queryPath + "/metrics");
                        } else {
                            $('#metricsLink-container').hide();
                        }

                        if (settings.heapDump) {
                            $('#heapDumpLink').attr("href", settings.queryPath + "/heapdump");
                        } else {
                            $('#heapDumpLink-container').hide();
                        }

                        if (settings.threadDump) {
                            $('#threadDumpLink').attr("href", settings.queryPath + "/threaddump");
                        } else {
                            $('#threadDumpLink-container').hide();
                        }

                        callApi(settings.queryPath + "/health");

                        getVersionInfo(settings.queryPath + "/info");

                    } catch (error) {
                        // Handle any errors that occur during the fetch or parsing
                        console.error('Error fetching data:', error);
                        $statusContainer.text("Error - Service unavailable");
                        $statusIndicator.attr("class", "status-indicator status-error");
                    }

                    return WidgetHelpers.WidgetStatusHelper.Success();
                }

                return {
                    load: function (widgetSettings) {
                        return getQueryInfo(widgetSettings);
                    },
                    reload: function (widgetSettings) {
                        return getQueryInfo(widgetSettings);
                    }
                }
            });
            VSS.notifyLoadSucceeded();
        });
    </script>
</head>

<body>
    <div class="extension-container">
        <div class="app-header">
            <div class="app-icon">APP</div>
            <div class="app-name">
                <div id="appName">Application</div>
                <div id="appVersion" class="app-version-error">Version Not Available</div>
            </div>
        </div>

        <div class="status-section">
            <div class="status-label">API Status</div>
            <div class="status-indicator status-success" id="statusIndicator">
                <div class="status-dot"></div>
                <span id="statusText"></span>
            </div>
        </div>

        <div class="actions-section">
            <div class="action-link" id="infoLink-container">
                <a href="#" class="" id="infoLink" target="_blank">
                    Info
                </a>
            </div>
            <div class="action-link" id="metricsLink-container">
                <a href="#" class="" id="metricsLink" target="_blank">
                    Metrics
                </a>
            </div>
            <div class="action-link" id="heapDumpLink-container">
                <a href="#" class="" id="heapDumpLink" target="_blank">
                    Heap Dump
                </a>
            </div>
            <div class="action-link" id="threadDumpLink-container">
                <a href="#" class="" id="threadDumpLink" target="_blank">
                    Thread Dump
                </a>
            </div>
        </div>
    </div>
</body>

</html>