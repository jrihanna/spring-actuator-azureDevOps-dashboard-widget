<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="css/widget-styles.css">
    <script src="sdk/scripts/VSS.SDK.min.js"></script>
    <script type="text/javascript">
        VSS.init({
            explicitNotifyLoaded: true,
            usePlatformStyles: true
        });

        VSS.require(["TFS/Dashboards/WidgetHelpers", "TFS/WorkItemTracking/RestClient",], function (WidgetHelpers, TFS_Wit_WebApi) {
            WidgetHelpers.IncludeWidgetStyles();
            VSS.register("SpringActuatorWidget", function () {
                var projectId = VSS.getWebContext().project.id;

                var getQueryInfo = async function (widgetSettings) {

                    // Extract query path from widgetSettings.customSettings and ask user to configure one if none is found
                    var settings = JSON.parse(widgetSettings.customSettings.data);
                    var $titleContainer = $('#appName');
                    $titleContainer.text(settings.urlName || "No Name Provided");

                    var $statusContainer = $('#statusText');

                    if (!settings || !settings.queryPath) {
                        $titleContainer.text(settings.urlName || "No Name Provided");
                        $statusIndicator.attr("class", "status-indicator status-error");

                        return WidgetHelpers.WidgetStatusHelper.Success();
                    }

                    try {

                        var $statusIndicator = $('#statusIndicator');
                        $statusIndicator.attr("class", "status-indicator status-loading");
                        $statusContainer.text("Checking - Validating services...");

                        // Make the API call
                        const response = await fetch(settings.queryPath + "");

                        // Parse the JSON response
                        const data = await response.json();
                        // Log the fetched data
                        if (data && data.completed !== undefined && data.completed == true) {
                            $statusContainer.text("Healthy - All services operational");
                            $statusIndicator.attr("class", "status-indicator status-success");
                        } else {
                            $statusContainer.text("Error - Service unavailable");
                            $statusIndicator.attr("class", "status-indicator status-error");
                        }

                        if (data) {
                            if (settings.info) {
                                $('#infoLink').attr("href", settings.queryPath + "/info");
                            } else {
                                $('#infoLink').hide();
                            }

                            if (settings.metrics) {
                                $('#metricsLink').attr("href", settings.queryPath + "/metrics");
                            } else {
                                $('#metricsLink').hide();
                            }

                            if (settings.heapDump) {
                                $('#heapDumpLink').attr("href", settings.queryPath + "/heapdump");
                            } else {
                                $('#heapDumpLink').hide();
                            }

                            if (settings.threadDump) {
                                $('#threadDumpLink').attr("href", settings.queryPath + "/threaddump");
                            } else {
                                $('#threadDumpLink').hide();
                            }

                            const firstVisibleLink = document.querySelector('a:not([style*="display: none"])');
                            if (firstVisibleLink) {
                                firstVisibleLink.classList.add('primary-link');
                            }
                        }

                        return WidgetHelpers.WidgetStatusHelper.Success();
                    } catch (error) {
                        // Handle any errors that occur during the fetch or parsing
                        console.error('Error fetching data:', error);
                        $statusContainer.text("Error - Service unavailable");
                        $statusIndicator.attr("class", "status-indicator status-error");
                    }
                }

                return {
                    load: function (widgetSettings) {
                        return getQueryInfo(widgetSettings);
                    },
                    reload: function (widgetSettings) {
                        return getQueryInfo(widgetSettings);
                    }
                }
            });
            VSS.notifyLoadSucceeded();
        });
    </script>
</head>

<body>
    <div class="extension-container">
        <div class="app-header">
            <div class="app-icon">APP</div>
            <div class="app-name" id="appName">Application</div>
        </div>

        <div class="status-section">
            <div class="status-label">API Status</div>
            <div class="status-indicator status-success" id="statusIndicator">
                <div class="status-dot"></div>
                <span id="statusText"></span>
            </div>
        </div>

        <div class="actions-section">
            <a href="#" class="action-link" id="infoLink" target="_blank">
                Info
            </a>
            <a href="#" class="action-link" id="metricsLink" target="_blank">
                Metrics
            </a>
            <a href="#" class="action-link" id="heapDumpLink" target="_blank">
                Heap Dump
            </a>
            <a href="#" class="action-link" id="threadDumpLink" target="_blank">
                Thread Dump
            </a>
        </div>
    </div>
</body>

</html>